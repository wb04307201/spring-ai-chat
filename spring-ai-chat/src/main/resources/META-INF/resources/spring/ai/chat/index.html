<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>èŠå¤©</title>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        body {
            height: 100vh;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            /*height: 760px;*/
            /*width: 900px;*/
            height: 100%;
            width: 100%;
            border-radius: 4px;
            border: 0.5px solid #e0e0e0;
            background-color: #f5f5f5;
            display: flex;
            flex-flow: column;
            overflow: hidden;
        }

        .content {
            width: calc(100% - 40px);
            padding: 20px;
            overflow-y: scroll;
            flex: 1;
        }

        .content:hover::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
        }

        .bubble {
            /*max-width: 400px;*/
            max-width: 75%;
            padding: 10px;
            border-radius: 5px;
            position: relative;
            color: #000;
            word-wrap: break-word;
            word-break: normal;
        }

        .item-left .bubble {
            margin-left: 15px;
            background-color: #fff;
        }

        .item-left .bubble:before {
            content: "";
            position: absolute;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-top: 10px solid transparent;
            border-right: 10px solid #fff;
            border-bottom: 10px solid transparent;
            left: -20px;
        }

        .item-right .bubble {
            margin-right: 15px;
            background-color: #9eea6a;
        }

        .item-right .bubble:before {
            content: "";
            position: absolute;
            width: 0;
            height: 0;
            border-left: 10px solid #9eea6a;
            border-top: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid transparent;
            right: -20px;
        }

        .item {
            margin-top: 15px;
            display: flex;
            width: 100%;
        }

        .item.item-right {
            justify-content: flex-end;
        }

        .item.item-center {
            justify-content: center;
        }

        .item.item-center span {
            font-size: 12px;
            padding: 2px 4px;
            color: #fff;
            background-color: #dadada;
            border-radius: 3px;
            -moz-user-select: none; /*ç«ç‹*/
            -webkit-user-select: none; /*webkitæµè§ˆå™¨*/
            -ms-user-select: none; /*IE10*/
            -khtml-user-select: none; /*æ—©æœŸæµè§ˆå™¨*/
            user-select: none;
        }

        .avatar img {
            width: 42px;
            height: 42px;
            border-radius: 50%;
        }

        .input-area {
            border-top: 0.5px solid #e0e0e0;
            height: 150px;
            display: flex;
            flex-flow: column;
            background-color: #fff;
        }

        textarea {
            flex: 1;
            padding: 5px;
            font-size: 14px;
            border: none;
            cursor: pointer;
            overflow-y: auto;
            overflow-x: hidden;
            outline: none;
            resize: none;
        }

        .button-area {
            display: flex;
            height: 40px;
            margin-right: 10px;
            line-height: 40px;
            padding: 5px;
            justify-content: flex-end;
        }

        .button-area button {
            width: 80px;
            border: none;
            outline: none;
            border-radius: 4px;
            float: right;
            cursor: pointer;
        }

        /* è®¾ç½®æ»šåŠ¨æ¡çš„æ ·å¼ */
        ::-webkit-scrollbar {
            width: 10px;
        }

        /* æ»šåŠ¨æ§½ */
        ::-webkit-scrollbar-track {
            border-radius: 8px;
        }

        /* æ»šåŠ¨æ¡æ»‘å— */
        ::-webkit-scrollbar-thumb {
            border-radius: 10px;
            background: rgba(0, 0, 0, 0);
        }

        .toolbar {
            height: 40px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            border-bottom: 0.5px solid #e0e0e0;
            background-color: #fafafa;
        }

        .toolbar-btn {
            /*width: 32px;*/
            height: 32px;
            margin: 0 5px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar-btn:hover {
            background-color: #e0e0e0;
        }

        #file-input-button {
            display: none;
        }

        #file-input {
            display: none;
        }

        #repo-button {
            display: none;
        }

        #toast-notification {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
            z-index: 1000;
        }
        #toast-notification.show {
            opacity: 1;
            visibility: visible;
        }
        #toast-notification.success {
            background-color: #28a745;
        }
        #toast-notification.error {
            background-color: #dc3545;
        }

        /* åœ¨ç°æœ‰CSSä¸­æ·»åŠ  */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 80%;
            max-width: 900px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close-button {
            font-size: 24px;
            cursor: pointer;
            color: #999;
            transition: color 0.2s;
        }

        .close-button:hover {
            color: #333;
        }

        .modal-body {
            padding: 16px 24px;
            overflow-y: auto;
            flex: 1;
        }

        .knowledge-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }

        .knowledge-table th,
        .knowledge-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .knowledge-table th {
            background-color: #f5f5f5;
            font-weight: 600;
            color: #555;
        }

        .knowledge-table tr:hover {
            background-color: #f9f9f9;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 4px 8px;
            border: 1px solid #ddd;
            background-color: #f8f9fa;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }

        .action-btn:hover {
            background-color: #e9ecef;
        }

    </style>
</head>
<body>
<div class="container">
    <div class="content" id="mainContent">
        <div class="item item-center"><span>ä½ ç°åœ¨å¯ä»¥å¼€å§‹èŠå¤©äº†</span></div>
    </div>
    <div class="input-area">
        <div class="toolbar">
            <button class="toolbar-btn" onclick="clearChat()">
                ğŸ—…æ¸…ç©ºå¯¹è¯
            </button>
            <button class="toolbar-btn" id="file-input-button" onclick="toggleFileUpload()">
                ğŸ“„ä¸Šä¼ æ–‡ä»¶
                <input type="file" id="file-input" accept="*/*">
            </button>
            <button class="toolbar-btn" id="repo-button" onclick="openModal()">
                ğŸ“šçŸ¥è¯†åº“
            </button>
        </div>
        <textarea name="text" id="textarea"></textarea>
        <div class="button-area">
            <button id="send-btn" onclick="send()">å‘ é€</button>
        </div>
    </div>
    <div id="toast-notification"></div>
    <div id="modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>çŸ¥è¯†åº“ç®¡ç†</h3>
                <span class="close-button" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <table id="knowledge-table" class="knowledge-table">
                    <thead>
                    <tr>
                        <th>æ–‡æ¡£åç§°</th>
                        <th>å¤§å°</th>
                        <th>ä¸Šä¼ æ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody id="table-body">
                    <!-- è¡¨æ ¼å†…å®¹å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
    let conversationId = Math.random().toString(12);
    let mainContent = document.getElementById('mainContent');
    let textarea = document.getElementById('textarea');
    let sendBtn = document.getElementById("send-btn")
    let fileInputButton = document.getElementById('file-input-button');
    let fileInput = document.getElementById('file-input');
    let repoButton = document.getElementById('repo-button');
    const toast = document.getElementById('toast-notification');
    let answerTextContent = null;
    let modalOverlay = null;
    let tableBody = null;

    document.addEventListener('DOMContentLoaded', (event) => {
        fetch('/spring/ai/chat/upload')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json()
            })
            .then(data => {
                if (data) {
                    fileInputButton.style.display = 'block';
                    repoButton.style.display = 'block';
                }
            })
            .catch(_ => {
                console.debug("ä¸å¼€å¯ä¸Šä¼ æŒ‰é’®")
            })
    })

    textarea.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && event.ctrlKey) {
            event.preventDefault();
            // è·å–å½“å‰å…‰æ ‡ä½ç½®
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            // åœ¨å…‰æ ‡ä½ç½®æ’å…¥æ¢è¡Œç¬¦
            textarea.value = textarea.value.substring(0, start) + '\n' + textarea.value.substring(end);
            // ç§»åŠ¨å…‰æ ‡åˆ°æ–°ä½ç½®
            textarea.setSelectionRange(start + 1, start + 1);
        }
        if (event.key === 'Enter' && !event.shiftKey && !event.ctrlKey) {
            event.preventDefault();
            send();
        }
    });

    // æ»šåŠ¨æ¡ç½®åº•
    function scrollToBottom() {
        mainContent.scrollTop = mainContent.scrollHeight;
    }

    // æ„å»ºç”¨æˆ·æ¶ˆæ¯
    function buildUserMessage(message) {
        let userItem = document.createElement('div');
        userItem.className = 'item item-right';
        userItem.innerHTML = `<div class="bubble bubble-left">${message}</div><div class="avatar"><img src="/spring/ai/chat/user.png"/></div>`;
        mainContent.appendChild(userItem);
        scrollToBottom();
    }

    // æ„å»ºæœºå™¨äººæ¶ˆæ¯
    function buildBotMessage(id) {
        let assistantItem = document.createElement('div');
        assistantItem.className = 'item item-left';
        assistantItem.innerHTML = `<div class="avatar"><img src="/spring/ai/chat/ai.png"/></div><div class="bubble bubble-left" id="${id}"></div>`;
        mainContent.appendChild(assistantItem);
        scrollToBottom();
    }

    function enableSendBtn() {
        textarea.disabled = false;
        sendBtn.disabled = false;
        sendBtn.textContent = 'å‘ é€';
    }

    function disableSendBtn() {
        textarea.value = '';
        textarea.disabled = true;
        sendBtn.disabled = true;
        sendBtn.textContent = 'æ­£åœ¨å‘é€...';
    }

    function showToast(message, type = 'success') {
        toast.textContent = message;
        toast.className = 'show';
        toast.classList.add(type);
        setTimeout(() => {
            toast.className = toast.className.replace('show', '');
        }, 3000);
    }

    function send() {
        const id = Date.now();
        let text = textarea.value.trim();
        if (!text) {
            buildBotMessage(id)
            answerTextContent = document.getElementById(id)
            answerTextContent.textContent = answerTextContent.textContent + "æŠ±æ­‰ï¼Œè¯·è¾“å…¥å†…å®¹ã€‚";
            scrollToBottom();
            answerTextContent = null;
            return;
        }

        buildUserMessage(text);

        disableSendBtn()

        buildBotMessage(id)
        answerTextContent = document.getElementById(id)

        fetch('/spring/ai/chat/stream', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: text, conversationId: conversationId}),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.body;
            })
            .then(body => {
                const reader = body.getReader();

                // è¯»å–æ•°æ®æµ
                function read() {
                    return reader.read().then(({done, value}) => {
                        // æ£€æŸ¥æ˜¯å¦è¯»å–å®Œæ¯•
                        if (done) {
                            console.log("æ¥æ”¶å®Œæˆ")
                            enableSendBtn();
                            answerTextContent = null;
                            return;
                        }
                        // å¤„ç†æ¯ä¸ªæ•°æ®å—
                        let context = new TextDecoder('utf-8').decode(value);
                        // console.log('æ”¶åˆ°çš„æ•°æ®:', context);

                        answerTextContent.textContent = answerTextContent.textContent + context;
                        scrollToBottom();

                        // ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªæ•°æ®å—
                        read();
                    });
                }

                // å¼€å§‹è¯»å–æ•°æ®æµ
                read();
            })
            .catch(error => {
                answerTextContent.textContent = answerTextContent.textContent + "æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯å¤±è´¥ã€‚";
                scrollToBottom();
                answerTextContent = null;
                console.error('There has been a problem with your fetch operation:', error);
                enableSendBtn()
            });
    }

    function clearChat() {
        mainContent.innerHTML = `<div class="item item-center"><span>ä½ ç°åœ¨å¯ä»¥å¼€å§‹èŠå¤©äº†</span></div>`
        conversationId = Math.random().toString(12);
    }

    function toggleFileUpload() {
        let fileInput = document.getElementById('file-input');
        fileInput.click();
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);


        fetch('/spring/ai/chat/upload', { // è¯·ç¡®ä¿æ­¤è·¯å¾„ä¸æ‚¨çš„åç«¯åŒ¹é…
            method: 'POST',
            body: formData,
        }).then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        }).then(data => {
            if (data){
                showToast(`æ–‡æ¡£ "${file.name}" ä¸Šä¼ æˆåŠŸï¼`, 'success');
            }
        }).catch( error =>{
            console.error('There has been a problem with your fetch operation:', error);
            showToast('ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è”ç³»ç®¡ç†å‘˜ã€‚', 'error');
        })
    }

    fileInput.addEventListener('change', handleFileUpload);

    // åœ¨DOMContentLoadedäº‹ä»¶ä¸­åˆå§‹åŒ–æ¨¡æ€æ¡†ç›¸å…³å…ƒç´ 
    document.addEventListener('DOMContentLoaded', (event) => {
        // åˆå§‹åŒ–æ¨¡æ€æ¡†å…ƒç´ 
        modalOverlay = document.getElementById('modal-overlay');
        tableBody = document.getElementById('table-body');

        // æ£€æŸ¥ä¸Šä¼ åŠŸèƒ½æ˜¯å¦å¯ç”¨
        fetch('/spring/ai/chat/upload')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json()
            })
            .then(data => {
                if (data) {
                    fileInputButton.style.display = 'block';
                    repoButton.style.display = 'block';
                }
            })
            .catch(_ => {
                console.debug("ä¸å¼€å¯ä¸Šä¼ æŒ‰é’®")
            });

        // ç‚¹å‡»é®ç½©å±‚å…³é—­æ¨¡æ€æ¡†
        modalOverlay.addEventListener('click', function(event) {
            if (event.target === modalOverlay) {
                closeModal();
            }
        });
    });

    function openModal() {
        modalOverlay.style.display = 'flex';
        loadKnowledgeData();
    }

    function closeModal() {
        modalOverlay.style.display = 'none';
    }

    function loadKnowledgeData() {
        // æ¸…ç©ºç°æœ‰è¡¨æ ¼å†…å®¹
        tableBody.innerHTML = '';

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const loadingRow = document.createElement('tr');
        loadingRow.innerHTML = '<td colspan="5" style="text-align: center;">åŠ è½½ä¸­...</td>';
        tableBody.appendChild(loadingRow);

        // è·å–çŸ¥è¯†åº“æ•°æ®
        fetch('/spring/ai/chat/knowledge')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.debug('data',data)

                // æ¸…é™¤åŠ è½½è¡Œ
                tableBody.innerHTML = '';

                // å¡«å……è¡¨æ ¼æ•°æ®
                if (data && data.length > 0) {
                    data.forEach(item => {
                        const row = document.createElement('tr');

                        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                        const fileSize = formatFileSize(item.size);
                        // æ ¼å¼åŒ–æ—¥æœŸ
                        const formattedDate = formatDate(item.uploadTime);

                        row.innerHTML = `
                        <td>${truncateText(item.fileName, 30)}</td>
                        <td>${fileSize}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn" onclick="deleteDocument('${item.id}', this)">åˆ é™¤</button>
                            </div>
                        </td>
                    `;
                        tableBody.appendChild(row);
                    });
                } else {
                    const emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = '<td colspan="5" style="text-align: center;">æš‚æ— çŸ¥è¯†åº“æ–‡æ¡£</td>';
                    tableBody.appendChild(emptyRow);
                }
            })
            .catch(error => {
                console.error('Error loading knowledge data:', error);
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</td></tr>';
            });
    }

    function deleteDocument(docId, element) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡æ¡£å—ï¼Ÿ')) {
            fetch(`/spring/ai/chat/knowledge/${docId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        // åˆ é™¤è¡¨æ ¼è¡Œ
                        element.closest('tr').remove();
                        showToast('çŸ¥è¯†åº“åˆ é™¤æˆåŠŸ', 'success');
                    }
                })
                .catch(error => {
                    console.error('Error deleting document:', error);
                    showToast('æ–‡æ¡£åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                });
        }
    }

    function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substr(0, maxLength) + '...';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatDate(dateString) {
        if (!dateString) return 'æœªçŸ¥';
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
</script>
</body>
</html>